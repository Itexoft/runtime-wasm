name: Build WASM Artifacts (Clean)
on:
  workflow_dispatch:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  RUNTIME_REPO: https://github.com/Itexoft/runtime
  RUNTIME_REF: wasm-dylink-pinvoke-10.0
  CONFIG: Release

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-webassembly-amd64
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: st-mm1
            threads: "false"
            mm: "1"
            copy_pack: "true"
          - name: st-mm2
            threads: "false"
            mm: "2"
            copy_pack: "false"
          - name: mt-mm1
            threads: "true"
            mm: "1"
            copy_pack: "true"
          - name: mt-mm2
            threads: "true"
            mm: "2"
            copy_pack: "false"
    env:
      ROOTFS_DIR: /crossrootfs/x64
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read VERSION
        id: version
        run: |
          set -euo pipefail
          v="$(cat VERSION)"
          if [[ -z "$v" ]]; then
            echo "::error::VERSION is empty"
            exit 1
          fi
          echo "value=$v" >> "$GITHUB_OUTPUT"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Install ICU headers
        run: |
          set -euo pipefail
          tdnf install -y icu-devel
          mkdir -p "$GITHUB_WORKSPACE/icu-headers/include"
          cp -a /usr/include/unicode "$GITHUB_WORKSPACE/icu-headers/include/"
          test -f "$GITHUB_WORKSPACE/icu-headers/include/unicode/ucurr.h"

      - name: Clone runtime
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${RUNTIME_REF}" "${RUNTIME_REPO}" runtime

      - name: Resolve build versions
        id: versions
        run: |
          set -euo pipefail
          emsdk_version="$(cat runtime/src/mono/browser/emscripten-version.txt)"
          if [[ -z "${emsdk_version}" ]]; then
            echo "::error::emscripten-version.txt is empty"
            exit 1
          fi
          icu_sha="$(python3 - <<'PY'
          import sys
          import xml.etree.ElementTree as ET
          path = "runtime/eng/Version.Details.xml"
          try:
              root = ET.parse(path).getroot()
          except Exception as e:
              print(f"::error::Failed to parse {path}: {e}", file=sys.stderr)
              sys.exit(1)
          deps = []
          for d in root.findall(".//Dependency"):
              name = d.get("Name", "")
              if name.startswith("Microsoft.NETCore.Runtime.ICU"):
                  sha = (d.findtext("Sha") or d.get("Sha") or "").strip()
                  deps.append((name, sha))
          if len(deps) != 1 or not deps[0][1]:
              print("::error::ICU dependency not found or SHA missing in Version.Details.xml", file=sys.stderr)
              for name, sha in deps:
                  print(f"::error::ICU dependency: {name} sha={sha}", file=sys.stderr)
              sys.exit(1)
          print(deps[0][1])
          PY
          )"
          echo "emsdk=$emsdk_version" >> "$GITHUB_OUTPUT"
          echo "icu=$icu_sha" >> "$GITHUB_OUTPUT"

      - name: Select local build roots
        id: roots
        run: |
          set -euo pipefail
          fs_type="$(stat -f -c %T "$GITHUB_WORKSPACE")"
          base="$GITHUB_WORKSPACE"
          case "$fs_type" in
            cifs|smb2|nfs|nfs4|fuse.sshfs)
              base="${RUNNER_TEMP:-/tmp}/runtime-wasm"
              ;;
          esac
          if [[ -z "$base" ]]; then
            echo "::error::LOCAL_BUILD_ROOT is empty"
            exit 1
          fi
          mkdir -p "$base"
          if ! command -v dotnet >/dev/null 2>&1; then
            echo "::error::dotnet not found in PATH"
            exit 1
          fi
          nuget_root="$(dotnet nuget locals global-packages -l | awk -F': ' '{print $2}' | tr -d '\r')"
          if [[ -z "$nuget_root" ]]; then
            echo "::error::Failed to resolve NuGet global-packages path"
            exit 1
          fi
          nuget_root="${nuget_root%/}"
          mkdir -p "$nuget_root"
          echo "NUGET_PACKAGES=$nuget_root" >> "$GITHUB_ENV"
          echo "LOCAL_BUILD_ROOT=$base" >> "$GITHUB_ENV"
          echo "EM_CACHE_DIR=$base/emscripten-cache" >> "$GITHUB_ENV"
          echo "ICU_REPO_DIR=$base/icu" >> "$GITHUB_ENV"
          echo "ICU_STAGE_DIR=$base/icu-stage" >> "$GITHUB_ENV"
          echo "RUNTIME_ARTIFACTS_DIR=$base/runtime-artifacts" >> "$GITHUB_ENV"
          echo "FROZEN_CACHE=" >> "$GITHUB_ENV"
          echo "EM_FROZEN_CACHE=0" >> "$GITHUB_ENV"
          echo "EMCC_FROZEN_CACHE=0" >> "$GITHUB_ENV"
          echo "WORKSPACE_FS_TYPE=$fs_type" >> "$GITHUB_ENV"

      - name: Restore NuGet cache
        id: cache-nuget
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ hashFiles('runtime/eng/Version.Details.xml') }}

      - name: Restore emsdk cache
        id: cache-emsdk
        uses: actions/cache/restore@v4
        with:
          path: runtime/src/mono/browser/emsdk
          key: emsdk-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Restore emscripten build cache
        id: cache-emcache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.EM_CACHE_DIR }}
          key: emcache-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Provision emsdk
        id: provision-emsdk
        run: |
          set -euo pipefail
          emsdk_version="${{ steps.versions.outputs.emsdk }}"
          if [[ ! -d "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk" ]]; then
            git clone https://github.com/emscripten-core/emsdk.git runtime/src/mono/browser/emsdk
          fi
          pushd runtime/src/mono/browser/emsdk
          if [[ ! -f "./emsdk" ]]; then
            echo "::error::emsdk script not found in runtime/src/mono/browser/emsdk"
            exit 1
          fi
          if [[ "${{ steps.cache-emsdk.outputs.cache-hit }}" != "true" ]]; then
            ./emsdk install "${emsdk_version}"
          fi
          ./emsdk activate "${emsdk_version}"
          popd
          if [[ ! -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/emsdk_env.sh" ]]; then
            echo "::error::emsdk_env.sh not found after emsdk install"
            exit 1
          fi
          emsdk_root="$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk"
          emscripten_up="$emsdk_root/upstream/emscripten"
          if [[ ! -d "$emscripten_up" ]]; then
            echo "::error::emscripten upstream not found: $emscripten_up"
            exit 1
          fi
          if [[ -e "$emsdk_root/emscripten" && ! -L "$emsdk_root/emscripten" ]]; then
            echo "::error::emscripten path exists and is not a symlink: $emsdk_root/emscripten"
            exit 1
          fi
          ln -sfn "$emscripten_up" "$emsdk_root/emscripten"
          stdio_ok=0
          if [[ -f "$emscripten_up/system/include/stdio.h" ]]; then
            stdio_ok=1
          elif [[ -f "$emscripten_up/system/lib/libc/musl/include/stdio.h" ]]; then
            stdio_ok=1
          elif [[ -f "$emscripten_up/cache/sysroot/include/stdio.h" ]]; then
            stdio_ok=1
          fi
          if [[ "$stdio_ok" -ne 1 ]]; then
            echo "::error::stdio.h not found under emscripten sysroot. Checked:"
            echo "  $emscripten_up/system/include/stdio.h"
            echo "  $emscripten_up/system/lib/libc/musl/include/stdio.h"
            echo "  $emscripten_up/cache/sysroot/include/stdio.h"
            exit 1
          fi
          mkdir -p "$emsdk_root/bin"
          tool_links=(
            "llvm-ar:$emsdk_root/upstream/bin/llvm-ar"
            "wasm-opt:$emsdk_root/upstream/bin/wasm-opt"
          )
          for entry in "${tool_links[@]}"; do
            name="${entry%%:*}"
            src="${entry#*:}"
            if [[ ! -x "$src" ]]; then
              echo "::error::Required emsdk tool not found or not executable: $src"
              exit 1
            fi
            ln -sfn "$src" "$emsdk_root/bin/$name"
            if [[ ! -x "$emsdk_root/bin/$name" ]]; then
              echo "::error::Tool symlink invalid: $emsdk_root/bin/$name"
              exit 1
            fi
          done
          echo "EMSDK_PATH=$emsdk_root" >> "$GITHUB_ENV"
          llvm_root="$emsdk_root/upstream/bin"
          if [[ ! -d "$llvm_root" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_LLVM_ROOT not found: $llvm_root"
            exit 1
          fi
          binaryen_root="$emsdk_root/upstream"
          if [[ ! -d "$binaryen_root" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_BINARYEN_ROOT not found: $binaryen_root"
            exit 1
          fi
          node_js="$emsdk_root/node/$(ls -1 "$emsdk_root/node" | head -n 1)/bin/node"
          if [[ ! -x "$node_js" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_NODE_JS not found: $node_js"
            exit 1
          fi
          echo "DOTNET_EMSCRIPTEN_LLVM_ROOT=$llvm_root" >> "$GITHUB_ENV"
          echo "DOTNET_EMSCRIPTEN_BINARYEN_ROOT=$binaryen_root" >> "$GITHUB_ENV"
          echo "DOTNET_EMSCRIPTEN_NODE_JS=$node_js" >> "$GITHUB_ENV"
          emcache="$EM_CACHE_DIR"
          mkdir -p "$emcache"
          cache_link="$emsdk_root/upstream/emscripten/cache"
          if [[ -e "$cache_link" && ! -L "$cache_link" ]]; then
            rm -rf "$cache_link"
          fi
          ln -sfn "$emcache" "$cache_link"

      - name: Save emsdk cache
        if: always() && steps.cache-emsdk.outputs.cache-hit != 'true' && steps.provision-emsdk.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: runtime/src/mono/browser/emsdk
          key: emsdk-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Clone ICU
        run: |
          set -euo pipefail
          icu_sha="${{ steps.versions.outputs.icu }}"
          if [[ -e "$ICU_REPO_DIR" && ! -d "$ICU_REPO_DIR/.git" ]]; then
            echo "::error::ICU path exists and is not a git repo: $ICU_REPO_DIR"
            exit 1
          fi
          if [[ ! -d "$ICU_REPO_DIR/.git" ]]; then
            git clone https://github.com/dotnet/icu "$ICU_REPO_DIR"
          fi
          git -C "$ICU_REPO_DIR" checkout "${icu_sha}"

      - name: Restore ICU artifacts cache
        id: cache-icu
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ICU_REPO_DIR }}/artifacts
          key: icu-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.icu }}-${{ steps.versions.outputs.emsdk }}-${{ env.CONFIG }}-pic2-threads-${{ matrix.threads }}

      - name: Restore ICU stage
        id: cache-icu-stage
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ICU_STAGE_DIR }}
          key: icu-stage-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.icu }}-${{ steps.versions.outputs.emsdk }}-${{ env.CONFIG }}-pic2-threads-${{ matrix.threads }}

      - name: Validate cached ICU stage
        if: steps.cache-icu-stage.outputs.cache-hit == 'true'
        run: |
          set -euo pipefail
          icu_stage="$ICU_STAGE_DIR"
          if [[ ! -d "$icu_stage" ]]; then
            echo "::error::ICU stage cache hit but directory is missing: $icu_stage"
            exit 1
          fi
          for f in libicuuc.a libicui18n.a libicudata.a; do
            if [[ ! -f "$icu_stage/lib/$f" ]]; then
              echo "::error::Missing ICU lib in cached stage: $icu_stage/lib/$f"
              exit 1
            fi
          done
          if [[ ! -d "$icu_stage/include/unicode" ]]; then
            echo "::error::Missing ICU headers in cached stage: $icu_stage/include/unicode"
            exit 1
          fi
          if [[ ! -f "$icu_stage/include/unicode/ucurr.h" ]]; then
            echo "::error::ICU header ucurr.h missing in cached stage: $icu_stage/include/unicode/ucurr.h"
            exit 1
          fi
          if ! compgen -G "$icu_stage/lib/*.dat" > /dev/null; then
            echo "::error::Missing ICU data files in cached stage: $icu_stage/lib"
            exit 1
          fi
          echo "ICU_DIR=$icu_stage" >> "$GITHUB_ENV"
          echo "ICU_LIB_DIR=$icu_stage/lib" >> "$GITHUB_ENV"

      - name: Restore runtime artifacts
        id: cache-runtime
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.RUNTIME_ARTIFACTS_DIR }}
          key: runtime-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ env.CONFIG }}-${{ env.RUNTIME_REF }}-${{ steps.versions.outputs.emsdk }}-${{ steps.versions.outputs.icu }}-threads-${{ matrix.threads }}-mm${{ matrix.mm }}

      - name: Ensure cache directories
        run: |
          set -euo pipefail
          mkdir -p "$NUGET_PACKAGES"
          mkdir -p "$EM_CACHE_DIR"
          mkdir -p "$RUNTIME_ARTIFACTS_DIR"
          if [[ "${{ steps.cache-icu-stage.outputs.cache-hit }}" == "true" ]]; then
            mkdir -p "$ICU_STAGE_DIR"
          fi

      - name: Patch ICU CFLAGS for PIC
        run: |
          set -euo pipefail
          mk="$ICU_REPO_DIR/eng/icu.browser.mk"
          if [[ ! -f "$mk" ]]; then
            echo "::error::icu.browser.mk not found: $mk"
            exit 1
          fi
          python3 - <<'PY'
          import os,sys
          path = os.path.join(os.environ["ICU_REPO_DIR"], "eng", "icu.browser.mk")
          text = open(path, encoding="utf-8").read()
          def add_pic(line):
              if "-fPIC" in line:
                return line
              return line.replace("-Wno-sign-compare", "-Wno-sign-compare -fPIC")
          new_lines = []
          changed = False
          for line in text.splitlines(True):
              if line.lstrip().startswith("CFLAGS="):
                  new_line = add_pic(line)
                  changed |= (new_line != line)
                  new_lines.append(new_line)
              elif line.lstrip().startswith("CXXFLAGS="):
                  new_line = add_pic(line)
                  changed |= (new_line != line)
                  new_lines.append(new_line)
              else:
                  new_lines.append(line)
          new_text = "".join(new_lines)
          if new_text == text:
              # require -fPIC to be present even if no change was needed
              if "CFLAGS=" in text and "-fPIC" in text and "CXXFLAGS=" in text and "-fPIC" in text:
                  sys.exit(0)
              print("::error::Failed to inject -fPIC into icu.browser.mk", file=sys.stderr)
              sys.exit(1)
          with open(path, "w", encoding="utf-8") as f:
              f.write(new_text)
          # verify
          if "-fPIC" not in new_text:
              print("::error::icu.browser.mk does not contain -fPIC after patch", file=sys.stderr)
              sys.exit(1)
          PY

      - name: Link ICU emsdk to runtime emsdk
        run: |
          set -euo pipefail
          runtime_emsdk="$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk"
          if [[ ! -f "$runtime_emsdk/emsdk_env.sh" ]]; then
            echo "::error::runtime emsdk_env.sh not found: $runtime_emsdk/emsdk_env.sh"
            exit 1
          fi
          icu_emsdk="$ICU_REPO_DIR/artifacts/obj/emsdk"
          mkdir -p "$(dirname "$icu_emsdk")"
          if [[ -e "$icu_emsdk" && ! -L "$icu_emsdk" ]]; then
            rm -rf "$icu_emsdk"
          fi
          ln -sfn "$runtime_emsdk" "$icu_emsdk"
          if [[ ! -f "$icu_emsdk/emsdk_env.sh" ]]; then
            echo "::error::icu emsdk link invalid: $icu_emsdk/emsdk_env.sh"
            exit 1
          fi

      - name: Build ICU (PIC)
        id: build-icu
        if: steps.cache-icu-stage.outputs.cache-hit != 'true'
        env:
          EXTRA_CFLAGS: "-fPIC"
          EXTRA_CXXFLAGS: "-fPIC"
          CFLAGS: "-fPIC"
          CXXFLAGS: "-fPIC"
        run: |
          set -euo pipefail
          source "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/emsdk_env.sh"
          export EM_CACHE="$EM_CACHE_DIR"
          mkdir -p "$EM_CACHE"
          icu_base="$ICU_REPO_DIR/artifacts/bin/icu-browser-wasm"
          icu_src_cfg="$icu_base/$CONFIG/runtimes/browser-wasm/native"
          icu_src_flat="$icu_base/runtimes/browser-wasm/native"
          icu_has_libs=0
          if [[ -f "$icu_base/lib/libicuuc.a" ]]; then
            icu_has_libs=1
          elif [[ -f "$icu_src_cfg/lib/libicuuc.a" ]]; then
            icu_has_libs=1
          elif [[ -f "$icu_src_flat/lib/libicuuc.a" ]]; then
            icu_has_libs=1
          elif [[ -f "$icu_src_cfg/libicuuc.a" ]]; then
            icu_has_libs=1
          elif [[ -f "$icu_src_flat/libicuuc.a" ]]; then
            icu_has_libs=1
          fi

          if [[ "$icu_has_libs" -ne 1 ]]; then
            pushd "$ICU_REPO_DIR"
            ./build.sh /p:TargetOS=Browser /p:TargetArchitecture=wasm /p:Configuration=$CONFIG /p:WasmEnableThreads=${{ matrix.threads }} /p:ExtraCFlags=-fPIC /p:ExtraCxxFlags=-fPIC
            popd
          fi

          icu_src=""
          icu_layout=""
          if [[ -d "$icu_src_cfg" ]]; then
            icu_src="$icu_src_cfg"
            icu_layout="native"
          elif [[ -d "$icu_src_flat" ]]; then
            icu_src="$icu_src_flat"
            icu_layout="native"
          elif [[ -d "$icu_base/lib" ]]; then
            icu_src="$icu_base"
            icu_layout="base"
          else
            echo "::error::ICU output not found. Expected one of:"
            echo "  $icu_src_cfg"
            echo "  $icu_src_flat"
            echo "  $icu_base (with lib/)"
            ls -la "$icu_base" || true
            exit 1
          fi

          icu_stage="$ICU_STAGE_DIR"
          if [[ -e "$icu_stage" ]]; then
            echo "::error::ICU stage already exists: $icu_stage"
            exit 1
          fi
          mkdir -p "$icu_stage/lib"
          mkdir -p "$icu_stage/include"

          if [[ "$icu_layout" == "base" ]]; then
            cp -f "$icu_src/lib/libicuuc.a" "$icu_stage/lib/"
            cp -f "$icu_src/lib/libicui18n.a" "$icu_stage/lib/"
            cp -f "$icu_src/lib/libicudata.a" "$icu_stage/lib/"
            cp -f "$icu_src/"*.dat "$icu_stage/lib/"
          else
            if [[ -d "$icu_src/lib" ]]; then
              cp -f "$icu_src/lib/libicuuc.a" "$icu_stage/lib/"
              cp -f "$icu_src/lib/libicui18n.a" "$icu_stage/lib/"
              cp -f "$icu_src/lib/libicudata.a" "$icu_stage/lib/"
              cp -f "$icu_src/lib/"*.dat "$icu_stage/lib/"
            else
              cp -f "$icu_src/libicuuc.a" "$icu_stage/lib/"
              cp -f "$icu_src/libicui18n.a" "$icu_stage/lib/"
              cp -f "$icu_src/libicudata.a" "$icu_stage/lib/"
              cp -f "$icu_src/"*.dat "$icu_stage/lib/"
            fi
          fi

          for f in libicuuc.a libicui18n.a libicudata.a; do
            if [[ ! -f "$icu_stage/lib/$f" ]]; then
              echo "::error::Missing ICU lib: $icu_stage/lib/$f"
              exit 1
            fi
          done
          if [[ ! -d "$GITHUB_WORKSPACE/icu-headers/include/unicode" ]]; then
            echo "::error::ICU headers not found: $GITHUB_WORKSPACE/icu-headers/include/unicode"
            exit 1
          fi
          cp -a "$GITHUB_WORKSPACE/icu-headers/include/unicode" "$icu_stage/include/"
          if [[ ! -f "$icu_stage/include/unicode/ucurr.h" ]]; then
            echo "::error::ICU header ucurr.h missing in stage: $icu_stage/include/unicode/ucurr.h"
            exit 1
          fi
          if ! compgen -G "$icu_stage/lib/*.dat" > /dev/null; then
            echo "::error::Missing ICU data files in $icu_stage/lib"
            exit 1
          fi

          echo "ICU_DIR=$icu_stage" >> "$GITHUB_ENV"
          echo "ICU_LIB_DIR=$icu_stage/lib" >> "$GITHUB_ENV"

      - name: Save ICU artifacts cache
        if: always() && steps.cache-icu.outputs.cache-hit != 'true' && steps.build-icu.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.ICU_REPO_DIR }}/artifacts
          key: icu-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.icu }}-${{ steps.versions.outputs.emsdk }}-${{ env.CONFIG }}-pic2-threads-${{ matrix.threads }}

      - name: Save ICU stage cache
        if: always() && steps.cache-icu-stage.outputs.cache-hit != 'true' && steps.build-icu.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.ICU_STAGE_DIR }}
          key: icu-stage-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.icu }}-${{ steps.versions.outputs.emsdk }}-${{ env.CONFIG }}-pic2-threads-${{ matrix.threads }}

      - name: Validate cached runtime artifacts
        if: steps.cache-runtime.outputs.cache-hit == 'true'
        run: |
          set -euo pipefail
          base="$RUNTIME_ARTIFACTS_DIR/bin"
          wasm="$base/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/native/dotnet.native.wasm"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            wasm="$base/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native/dotnet.native.wasm"
          fi
          if [[ ! -f "$wasm" ]]; then
            echo "::error::Cached runtime artifacts missing dotnet.native.wasm: $wasm"
            exit 1
          fi
          if [[ "${{ matrix.copy_pack }}" == "true" ]]; then
            if [[ "${{ matrix.threads }}" == "true" ]]; then
              if [[ ! -d "$base/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native" ]]; then
                echo "::error::Cached runtime pack missing native.multithread runtime"
                exit 1
              fi
            else
              if [[ ! -d "$base/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm" ]]; then
                echo "::error::Cached runtime pack missing runtimes/browser-wasm"
                exit 1
              fi
            fi
          fi

      - name: Build
        id: build-runtime
        if: steps.cache-runtime.outputs.cache-hit != 'true'
        env:
          EXTRA_CFLAGS: "-fPIC"
          EXTRA_CXXFLAGS: "-fPIC"
          EMCC_DEBUG: "1"
        run: |
          set -euo pipefail
          cache="$EM_CACHE_DIR"
          mkdir -p "$cache"
          export EM_CACHE="$cache"

          extra_cflags="-I$GITHUB_WORKSPACE/icu-headers/include -fPIC -DWASM_SUPPORTS_DLOPEN=1"
          extra_ld="-s MAIN_MODULE=${{ matrix.mm }}"
          wasm_enable_simd="true"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            extra_cflags="${extra_cflags} -pthread"
            extra_ld="${extra_ld} -pthread -Wno-experimental"
          fi

          ./runtime/build.sh \
            -s mono.runtime+mono.wasmruntime+libs.native+packs \
            -os browser -arch wasm -c "$CONFIG" \
            /p:WasmEnableThreads=${{ matrix.threads }} \
            "/p:__RootBinDir=$RUNTIME_ARTIFACTS_DIR/" \
            /p:BuildTests=false \
            /p:RunTests=false \
            "/p:ICULibDir=$ICU_LIB_DIR" \
            "/p:IcuDir=$ICU_DIR" \
            "/p:CMakeArgs=-DCMAKE_POSITION_INDEPENDENT_CODE=ON" \
            "/p:EmccExtraCFlags=$extra_cflags" \
            "/p:EmccExtraLDFlags=${extra_ld}" \
            "/p:WasmEnableSIMD=${wasm_enable_simd}" \
            "/p:WasmCachePath=$cache"

      - name: Verify wasm flags consistency
        if: steps.cache-runtime.outputs.cache-hit == 'true' || steps.build-runtime.outcome == 'success'
        run: |
          set -euo pipefail
          native_bin="$RUNTIME_ARTIFACTS_DIR/bin/native/net10.0-browser-Release-wasm"
          rsp_dir="$native_bin/src"
          for f in emcc-default.rsp emcc-compile.rsp emcc-link.rsp; do
            if [[ ! -f "$rsp_dir/$f" ]]; then
              echo "::error::Missing $rsp_dir/$f"
              exit 1
            fi
          done

          compile_flags="$(tr '\n' ' ' < "$rsp_dir/emcc-compile.rsp")"
          link_flags="$(tr '\n' ' ' < "$rsp_dir/emcc-link.rsp")"

          if ! grep -q -- "-fPIC" "$rsp_dir/emcc-compile.rsp"; then
            echo "::error::-fPIC missing in emcc-compile.rsp"
            exit 1
          fi
          if ! grep -q -- "-DWASM_SUPPORTS_DLOPEN=1" "$rsp_dir/emcc-compile.rsp"; then
            echo "::error::-DWASM_SUPPORTS_DLOPEN=1 missing in emcc-compile.rsp"
            exit 1
          fi

          if ! grep -q -- "MAIN_MODULE=${{ matrix.mm }}" "$rsp_dir/emcc-link.rsp"; then
            echo "::error::MAIN_MODULE=${{ matrix.mm }} missing in emcc-link.rsp"
            exit 1
          fi

          if [[ "${{ matrix.threads }}" == "true" ]]; then
            if ! grep -q -- "USE_PTHREADS=1" "$rsp_dir/emcc-link.rsp"; then
              echo "::error::USE_PTHREADS=1 missing in emcc-link.rsp for threads=true"
              exit 1
            fi
            if ! grep -q -- "-pthread" "$rsp_dir/emcc-compile.rsp"; then
              echo "::error::-pthread missing in emcc-compile.rsp for threads=true"
              exit 1
            fi
            if ! grep -q -- "-Wno-experimental" "$rsp_dir/emcc-link.rsp"; then
              echo "::error::-Wno-experimental missing in emcc-link.rsp for threads=true"
              exit 1
            fi
          else
            if grep -q -- "USE_PTHREADS=1" "$rsp_dir/emcc-link.rsp"; then
              echo "::error::USE_PTHREADS=1 present in emcc-link.rsp for threads=false"
              exit 1
            fi
            if grep -q -- "-pthread" "$rsp_dir/emcc-compile.rsp"; then
              echo "::error::-pthread present in emcc-compile.rsp for threads=false"
              exit 1
            fi
            if grep -q -- "-Wno-experimental" "$rsp_dir/emcc-link.rsp"; then
              echo "::error::-Wno-experimental present in emcc-link.rsp for threads=false"
              exit 1
            fi
          fi

          if [[ ! -f "$native_bin/CMakeCache.txt" ]]; then
            echo "::error::Missing CMakeCache.txt: $native_bin/CMakeCache.txt"
            exit 1
          fi
          if ! grep -q -- "CMAKE_POSITION_INDEPENDENT_CODE:BOOL=ON" "$native_bin/CMakeCache.txt"; then
            echo "::error::CMAKE_POSITION_INDEPENDENT_CODE is not ON in CMakeCache.txt"
            exit 1
          fi
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            if ! grep -q -- "CONFIGURATION_WASM_OPT_FLAGS:STRING=.*--enable-threads" "$native_bin/CMakeCache.txt"; then
              echo "::error::CONFIGURATION_WASM_OPT_FLAGS missing --enable-threads in CMakeCache.txt"
              exit 1
            fi
          else
            if grep -q -- "CONFIGURATION_WASM_OPT_FLAGS:STRING=.*--enable-threads" "$native_bin/CMakeCache.txt"; then
              echo "::error::CONFIGURATION_WASM_OPT_FLAGS includes --enable-threads for threads=false"
              exit 1
            fi
          fi
          if ! grep -q -- "CONFIGURATION_WASM_OPT_FLAGS:STRING=.*--enable-simd" "$native_bin/CMakeCache.txt"; then
            echo "::error::CONFIGURATION_WASM_OPT_FLAGS missing --enable-simd in CMakeCache.txt"
            exit 1
          fi

          obj_root="$RUNTIME_ARTIFACTS_DIR/obj/native/net10.0-browser-Release-wasm"
          if [[ -d "$obj_root" ]]; then
            mapfile -t flag_files < <(find "$obj_root" -name "flags.make")
            if [[ "${#flag_files[@]}" -eq 0 ]]; then
              echo "::error::No flags.make files found under $obj_root"
              exit 1
            fi
            for f in "${flag_files[@]}"; do
              if ! grep -q -- "-fPIC" "$f"; then
                echo "::error::-fPIC missing in $f"
                exit 1
              fi
              if ! grep -q -- "-msimd128" "$f"; then
                echo "::error::-msimd128 missing in $f"
                exit 1
              fi
              if [[ "${{ matrix.threads }}" == "true" ]]; then
                if ! grep -q -- "-pthread" "$f"; then
                  echo "::error::-pthread missing in $f for threads=true"
                  exit 1
                fi
              else
                if grep -q -- "-pthread" "$f"; then
                  echo "::error::-pthread present in $f for threads=false"
                  exit 1
                fi
              fi
            done
          else
            echo "::error::Missing obj root: $obj_root"
            exit 1
          fi

          echo "compile_flags=$compile_flags" >> "$GITHUB_OUTPUT"
          echo "link_flags=$link_flags" >> "$GITHUB_OUTPUT"

      - name: Collect diagnostics
        if: always()
        run: |
          set -euo pipefail
          out="$GITHUB_WORKSPACE/artifacts/diagnostics/${{ matrix.name }}"
          mkdir -p "$out"

          native_bin="$RUNTIME_ARTIFACTS_DIR/bin/native/net10.0-browser-Release-wasm"
          if [[ -d "$native_bin" ]]; then
            mkdir -p "$out/native-bin"
            if [[ -d "$native_bin/src" ]]; then
              cp -a "$native_bin/src" "$out/native-bin/"
            fi
            if [[ -f "$native_bin/CMakeCache.txt" ]]; then
              cp -f "$native_bin/CMakeCache.txt" "$out/native-bin/"
            fi
            for f in dotnet.native.wasm dotnet.native.js dotnet.native.js.map; do
              if [[ -f "$native_bin/$f" ]]; then
                cp -f "$native_bin/$f" "$out/native-bin/"
              fi
            done
          fi

          pack_base="$RUNTIME_ARTIFACTS_DIR/bin"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            pack_dir="$pack_base/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native"
          else
            pack_dir="$pack_base/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/native"
          fi
          if [[ -d "$pack_dir" ]]; then
            mkdir -p "$out/runtime-pack"
            if [[ -f "$pack_dir/dotnet.native.wasm" ]]; then
              cp -f "$pack_dir/dotnet.native.wasm" "$out/runtime-pack/"
            fi
          fi

          obj_root="$RUNTIME_ARTIFACTS_DIR/obj/native/net10.0-browser-Release-wasm"
          if [[ -d "$obj_root" ]]; then
            mkdir -p "$out/obj-native"
            find "$obj_root" -type f \( -name "flags.make" -o -name "link.txt" -o -name "CMakeCache.txt" \) | while read -r f; do
              rel="${f#$obj_root/}"
              mkdir -p "$out/obj-native/$(dirname "$rel")"
              cp -f "$f" "$out/obj-native/$rel"
            done
          fi

          if [[ -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/.emscripten" ]]; then
            cp -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/.emscripten" "$out/"
          fi
          if [[ -f "$EM_CACHE_DIR/sanity.txt" ]]; then
            cp -f "$EM_CACHE_DIR/sanity.txt" "$out/"
          fi
          if [[ -d "$RUNTIME_ARTIFACTS_DIR/log" ]]; then
            cp -a "$RUNTIME_ARTIFACTS_DIR/log" "$out/"
          fi
          if [[ -d /tmp/emscripten_temp ]]; then
            tar -czf "$out/emscripten_temp.tgz" -C /tmp emscripten_temp
          fi

      - name: Save runtime artifacts cache
        if: always() && steps.cache-runtime.outputs.cache-hit != 'true' && steps.build-runtime.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.RUNTIME_ARTIFACTS_DIR }}
          key: runtime-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ env.CONFIG }}-${{ env.RUNTIME_REF }}-${{ steps.versions.outputs.emsdk }}-${{ steps.versions.outputs.icu }}-threads-${{ matrix.threads }}-mm${{ matrix.mm }}

      - name: Save emscripten build cache
        if: always() && steps.cache-emcache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.EM_CACHE_DIR }}
          key: emcache-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Save NuGet cache
        if: always() && steps.cache-nuget.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ hashFiles('runtime/eng/Version.Details.xml') }}

      - name: Assemble artifacts
        run: |
          set -euo pipefail
          out="$GITHUB_WORKSPACE/artifacts/${{ matrix.name }}"
          mkdir -p "$out/runtimes/browser-wasm/native"

          wasm="$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/native/dotnet.native.wasm"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            wasm="$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native/dotnet.native.wasm"
          fi

          suffix="st"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            suffix="mt"
          fi

          cp -f "$wasm" "$out/runtimes/browser-wasm/native/dotnet.native.${suffix}.dl.mm${{ matrix.mm }}.wasm"

          if [[ "${{ matrix.copy_pack }}" == "true" ]]; then
            if [[ "${{ matrix.threads }}" == "true" ]]; then
              mkdir -p "$out/runtimes/browser-wasm/native.multithread"
              cp -a "$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native" "$out/runtimes/browser-wasm/native.multithread"
            else
              cp -a "$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes" "$out/"
            fi
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runtime-wasm-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}
          if-no-files-found: error
          retention-days: 1
