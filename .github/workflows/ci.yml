name: Build WASM Artifacts (Clean)
on:
  workflow_dispatch:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  RUNTIME_REPO: https://github.com/Itexoft/runtime
  RUNTIME_REF: wasm-dylink-pinvoke-10.0
  CONFIG: Release
  EMSDK_VERSION: latest
  WASM_OPT_MIN_VERSION: "125"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-webassembly-amd64
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: st-mm1
            threads: "false"
            mm: "1"
            copy_pack: "true"
          - name: st-mm2
            threads: "false"
            mm: "2"
            copy_pack: "false"
          - name: mt-mm1
            threads: "true"
            mm: "1"
            copy_pack: "false"
          - name: mt-mm2
            threads: "true"
            mm: "2"
            copy_pack: "false"
    env:
      ROOTFS_DIR: /crossrootfs/x64
      RUNTIME_ARTIFACTS_DIR: ${{ github.workspace }}/runtime/artifacts
      EM_CACHE_DIR: ${{ github.workspace }}/emscripten-cache
      CFLAGS: ""
      CXXFLAGS: ""
      CPPFLAGS: ""
      LDFLAGS: ""
      SDKROOT: ""
      MACOSX_DEPLOYMENT_TARGET: ""
      CMAKE_OSX_DEPLOYMENT_TARGET: ""
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read VERSION
        id: version
        run: |
          set -euo pipefail
          v="$(cat VERSION)"
          if [[ -z "$v" ]]; then
            echo "::error::VERSION is empty"
            exit 1
          fi
          echo "value=$v" >> "$GITHUB_OUTPUT"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Clone runtime
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${RUNTIME_REF}" "${RUNTIME_REPO}" runtime

      - name: Resolve build versions
        id: versions
        run: |
          set -euo pipefail
          emsdk_version="${EMSDK_VERSION}"
          if [[ -z "${emsdk_version}" ]]; then
            echo "::error::EMSDK_VERSION is empty"
            exit 1
          fi
          runtime_commit="$(git -C runtime rev-parse HEAD)"
          if [[ -z "$runtime_commit" ]]; then
            echo "::error::Failed to resolve runtime commit"
            exit 1
          fi
          icu_transport="$(python3 - <<'PY'
          import sys
          import xml.etree.ElementTree as ET
          path = "runtime/eng/Version.Details.props"
          try:
              root = ET.parse(path).getroot()
          except Exception as e:
              print(f"::error::Failed to parse {path}: {e}", file=sys.stderr)
              sys.exit(1)
          version = ""
          for prop in root.iter():
              if prop.tag.endswith("MicrosoftNETCoreRuntimeICUTransportPackageVersion"):
                  version = (prop.text or "").strip()
                  break
          if not version:
              print("::error::ICU transport package version not found in Version.Details.props", file=sys.stderr)
              sys.exit(1)
          print(version)
          PY
          )"
          echo "emsdk=$emsdk_version" >> "$GITHUB_OUTPUT"
          echo "runtime_commit=$runtime_commit" >> "$GITHUB_OUTPUT"
          echo "icu=$icu_transport" >> "$GITHUB_OUTPUT"

      - name: Select local build roots
        id: roots
        run: |
          set -euo pipefail
          fs_type="$(stat -f -c %T "$GITHUB_WORKSPACE")"
          base="$GITHUB_WORKSPACE"
          case "$fs_type" in
            cifs|smb2|nfs|nfs4|fuse.sshfs)
              base="${RUNNER_TEMP:-/tmp}/runtime-wasm"
              ;;
          esac
          if [[ -z "$base" ]]; then
            echo "::error::LOCAL_BUILD_ROOT is empty"
            exit 1
          fi
          mkdir -p "$base"
          if ! command -v dotnet >/dev/null 2>&1; then
            echo "::error::dotnet not found in PATH"
            exit 1
          fi
          nuget_root="$(dotnet nuget locals global-packages -l | awk -F': ' '{print $2}' | tr -d '\r')"
          if [[ -z "$nuget_root" ]]; then
            echo "::error::Failed to resolve NuGet global-packages path"
            exit 1
          fi
          nuget_root="${nuget_root%/}"
          mkdir -p "$nuget_root"
          echo "NUGET_PACKAGES=$nuget_root" >> "$GITHUB_ENV"
          echo "LOCAL_BUILD_ROOT=$base" >> "$GITHUB_ENV"
          echo "EM_CACHE_DIR=$base/emscripten-cache/${{ matrix.name }}" >> "$GITHUB_ENV"
          echo "RUNTIME_ARTIFACTS_DIR=$GITHUB_WORKSPACE/runtime/artifacts" >> "$GITHUB_ENV"
          echo "FROZEN_CACHE=" >> "$GITHUB_ENV"
          echo "EM_FROZEN_CACHE=0" >> "$GITHUB_ENV"
          echo "EMCC_FROZEN_CACHE=0" >> "$GITHUB_ENV"
          echo "WORKSPACE_FS_TYPE=$fs_type" >> "$GITHUB_ENV"

      - name: Restore NuGet cache
        id: cache-nuget
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ hashFiles('runtime/eng/Version.Details.xml') }}

      - name: Restore emsdk cache
        id: cache-emsdk
        uses: actions/cache/restore@v4
        with:
          path: runtime/src/mono/browser/emsdk
          key: emsdk-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Restore emscripten build cache
        id: cache-emcache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.EM_CACHE_DIR }}
          key: emcache-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}-${{ matrix.name }}

      - name: Provision emsdk
        id: provision-emsdk
        run: |
          set -euo pipefail
          if [[ -z "${EM_CACHE_DIR:-}" ]]; then
            echo "::error::EM_CACHE_DIR is not set"
            exit 1
          fi
          emsdk_version="${{ steps.versions.outputs.emsdk }}"
          if [[ ! -d "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk" ]]; then
            git clone https://github.com/emscripten-core/emsdk.git runtime/src/mono/browser/emsdk
          fi
          pushd runtime/src/mono/browser/emsdk
          if [[ ! -f "./emsdk" ]]; then
            echo "::error::emsdk script not found in runtime/src/mono/browser/emsdk"
            exit 1
          fi
          if [[ "${{ steps.cache-emsdk.outputs.cache-hit }}" != "true" ]]; then
            ./emsdk install "${emsdk_version}"
          fi
          ./emsdk activate "${emsdk_version}"
          popd
          if [[ ! -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/emsdk_env.sh" ]]; then
            echo "::error::emsdk_env.sh not found after emsdk install"
            exit 1
          fi
          emsdk_root="$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk"
          emscripten_up="$emsdk_root/upstream/emscripten"
          if [[ ! -d "$emscripten_up" ]]; then
            echo "::error::emscripten upstream not found: $emscripten_up"
            exit 1
          fi
          if [[ -e "$emsdk_root/emscripten" && ! -L "$emsdk_root/emscripten" ]]; then
            echo "::error::emscripten path exists and is not a symlink: $emsdk_root/emscripten"
            exit 1
          fi
          ln -sfn "$emscripten_up" "$emsdk_root/emscripten"
          stdio_ok=0
          if [[ -f "$emscripten_up/system/include/stdio.h" ]]; then
            stdio_ok=1
          elif [[ -f "$emscripten_up/system/lib/libc/musl/include/stdio.h" ]]; then
            stdio_ok=1
          elif [[ -f "$emscripten_up/cache/sysroot/include/stdio.h" ]]; then
            stdio_ok=1
          fi
          if [[ "$stdio_ok" -ne 1 ]]; then
            echo "::error::stdio.h not found under emscripten sysroot. Checked:"
            echo "  $emscripten_up/system/include/stdio.h"
            echo "  $emscripten_up/system/lib/libc/musl/include/stdio.h"
            echo "  $emscripten_up/cache/sysroot/include/stdio.h"
            exit 1
          fi
          mkdir -p "$emsdk_root/bin"
          tool_links=(
            "llvm-ar:$emsdk_root/upstream/bin/llvm-ar"
            "wasm-opt:$emsdk_root/upstream/bin/wasm-opt"
          )
          for entry in "${tool_links[@]}"; do
            name="${entry%%:*}"
            src="${entry#*:}"
            if [[ ! -x "$src" ]]; then
              echo "::error::Required emsdk tool not found or not executable: $src"
              exit 1
            fi
            ln -sfn "$src" "$emsdk_root/bin/$name"
            if [[ ! -x "$emsdk_root/bin/$name" ]]; then
              echo "::error::Tool symlink invalid: $emsdk_root/bin/$name"
              exit 1
            fi
          done
          wasm_opt="$emsdk_root/bin/wasm-opt"
          if [[ ! -x "$wasm_opt" ]]; then
            echo "::error::wasm-opt not found under EMSDK_PATH: $wasm_opt"
            exit 1
          fi
          wasm_opt_version="$("$wasm_opt" --version | awk '{print $3}')"
          if [[ -z "$wasm_opt_version" ]]; then
            echo "::error::Failed to parse wasm-opt version"
            exit 1
          fi
          case "$wasm_opt_version" in
            ''|*[!0-9]*)
              echo "::error::Unexpected wasm-opt version format: $wasm_opt_version"
              exit 1
              ;;
          esac
          if [[ -z "${WASM_OPT_MIN_VERSION:-}" ]]; then
            echo "::error::WASM_OPT_MIN_VERSION is not set"
            exit 1
          fi
          case "$WASM_OPT_MIN_VERSION" in
            ''|*[!0-9]*)
              echo "::error::WASM_OPT_MIN_VERSION must be numeric: $WASM_OPT_MIN_VERSION"
              exit 1
              ;;
          esac
          if (( wasm_opt_version < WASM_OPT_MIN_VERSION )); then
            echo "::error::wasm-opt version too old ($wasm_opt_version), expected >= $WASM_OPT_MIN_VERSION"
            exit 1
          fi
          echo "EMSDK_PATH=$emsdk_root" >> "$GITHUB_ENV"
          llvm_root="$emsdk_root/upstream/bin"
          if [[ ! -d "$llvm_root" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_LLVM_ROOT not found: $llvm_root"
            exit 1
          fi
          binaryen_root="$emsdk_root/upstream"
          if [[ ! -d "$binaryen_root" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_BINARYEN_ROOT not found: $binaryen_root"
            exit 1
          fi
          node_js="$emsdk_root/node/$(ls -1 "$emsdk_root/node" | head -n 1)/bin/node"
          if [[ ! -x "$node_js" ]]; then
            echo "::error::DOTNET_EMSCRIPTEN_NODE_JS not found: $node_js"
            exit 1
          fi
          echo "DOTNET_EMSCRIPTEN_LLVM_ROOT=$llvm_root" >> "$GITHUB_ENV"
          echo "DOTNET_EMSCRIPTEN_BINARYEN_ROOT=$binaryen_root" >> "$GITHUB_ENV"
          echo "DOTNET_EMSCRIPTEN_NODE_JS=$node_js" >> "$GITHUB_ENV"
          emcache="$EM_CACHE_DIR"
          mkdir -p "$emcache"
          cache_link="$emsdk_root/upstream/emscripten/cache"
          if [[ -e "$cache_link" && ! -L "$cache_link" ]]; then
            rm -rf "$cache_link"
          fi
          ln -sfn "$emcache" "$cache_link"

      - name: Replace emscripten system_libs.py (mt)
        if: matrix.threads == 'true'
        run: |
          set -euo pipefail
          src="$GITHUB_WORKSPACE/.github/emscripten/system_libs.py"
          dst="$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/upstream/emscripten/tools/system_libs.py"
          if [[ ! -f "$src" ]]; then
            echo "::error::replacement system_libs.py not found: $src"
            exit 1
          fi
          if [[ ! -f "$dst" ]]; then
            echo "::error::target system_libs.py not found: $dst"
            exit 1
          fi
          cp -f "$src" "$dst"

      - name: Export emsdk environment
        run: |
          set -euo pipefail
          if [[ -z "${EMSDK_PATH:-}" ]]; then
            echo "::error::EMSDK_PATH is not set"
            exit 1
          fi
          if [[ -z "${EM_CACHE_DIR:-}" ]]; then
            echo "::error::EM_CACHE_DIR is not set"
            exit 1
          fi
          emsdk_root="${EMSDK_PATH%/}"
          if [[ ! -f "$emsdk_root/emsdk_env.sh" ]]; then
            echo "::error::emsdk_env.sh not found: $emsdk_root/emsdk_env.sh"
            exit 1
          fi
          if [[ ! -x "$emsdk_root/upstream/emscripten/emcc" ]]; then
            echo "::error::emcc not found under EMSDK_PATH: $emsdk_root/upstream/emscripten/emcc"
            exit 1
          fi
          echo "EMSDK_PATH=$emsdk_root" >> "$GITHUB_ENV"
          echo "EM_CONFIG=$emsdk_root/.emscripten" >> "$GITHUB_ENV"
          echo "EM_CACHE=$EM_CACHE_DIR" >> "$GITHUB_ENV"
          echo "PATH=$emsdk_root/upstream/emscripten:$emsdk_root/upstream/bin:$PATH" >> "$GITHUB_ENV"

      - name: Reset emscripten cache (threads)
        if: matrix.threads == 'true'
        run: |
          set -euo pipefail
          if [[ -z "${EMSDK_PATH:-}" ]]; then
            echo "::error::EMSDK_PATH is not set"
            exit 1
          fi
          if [[ -z "${EM_CACHE_DIR:-}" ]]; then
            echo "::error::EM_CACHE_DIR is not set"
            exit 1
          fi
          emcc="$EMSDK_PATH/upstream/emscripten/emcc"
          if [[ ! -x "$emcc" ]]; then
            echo "::error::emcc not found under EMSDK_PATH: $emcc"
            exit 1
          fi
          export EM_CACHE="$EM_CACHE_DIR"
          export EMCC_CFLAGS="-pthread -matomics -mbulk-memory"
          export EMCC_LDFLAGS="-pthread -matomics -mbulk-memory"
          "$emcc" --clear-cache
          "$emcc" --clear-ports
          rm -rf "$EM_CACHE_DIR"/*
          mkdir -p "$EM_CACHE_DIR"
          warmup_c="$EM_CACHE_DIR/emscripten_warmup.c"
          cat > "$warmup_c" <<'EOF'
          int main(void) { return 0; }
          EOF
          "$emcc" "$warmup_c" -o "${warmup_c%.c}.js" -pthread -matomics -mbulk-memory -s WASM_BIGINT=1
          rm -f "$warmup_c" "${warmup_c%.c}.js" "${warmup_c%.c}.wasm"

      - name: Save emsdk cache
        if: always() && steps.cache-emsdk.outputs.cache-hit != 'true' && steps.provision-emsdk.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: runtime/src/mono/browser/emsdk
          key: emsdk-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}

      - name: Restore runtime artifacts
        id: cache-runtime
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.RUNTIME_ARTIFACTS_DIR }}
          key: runtime-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ env.CONFIG }}-${{ env.RUNTIME_REF }}-${{ steps.versions.outputs.runtime_commit }}-${{ steps.versions.outputs.emsdk }}-${{ steps.versions.outputs.icu }}-threads-${{ matrix.threads }}-mm${{ matrix.mm }}-${{ matrix.name }}

      - name: Ensure cache directories
        run: |
          set -euo pipefail
          if [[ -z "${NUGET_PACKAGES:-}" ]]; then
            echo "::error::NUGET_PACKAGES is not set"
            exit 1
          fi
          if [[ -z "${EM_CACHE_DIR:-}" ]]; then
            echo "::error::EM_CACHE_DIR is not set"
            exit 1
          fi
          if [[ -z "${RUNTIME_ARTIFACTS_DIR:-}" ]]; then
            echo "::error::RUNTIME_ARTIFACTS_DIR is not set"
            exit 1
          fi
          mkdir -p "$NUGET_PACKAGES"
          mkdir -p "$EM_CACHE_DIR"
          mkdir -p "$RUNTIME_ARTIFACTS_DIR"

      - name: Restore ICU transport package
        run: |
          set -euo pipefail
          dotnet restore runtime/src/mono/browser/browser.proj \
            /p:WasmEnableThreads=${{ matrix.threads }} \
            /p:BuildTests=false \
            /p:RunTests=false

      - name: Resolve ICU transport pack
        run: |
          set -euo pipefail
          icu_version="${{ steps.versions.outputs.icu }}"
          if [[ -z "$icu_version" ]]; then
            echo "::error::ICU transport version is empty"
            exit 1
          fi
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            icu_runtime="browser-wasm-threads"
          else
            icu_runtime="browser-wasm"
          fi
          icu_root="$NUGET_PACKAGES/microsoft.netcore.runtime.icu.transport/$icu_version/runtimes/$icu_runtime/native"
          if [[ ! -d "$icu_root" ]]; then
            echo "::error::ICU runtime pack not found: $icu_root"
            exit 1
          fi
          echo "ICU_DIR=$icu_root" >> "$GITHUB_ENV"
          echo "ICU_LIB_DIR=$icu_root/lib" >> "$GITHUB_ENV"
      - name: Validate cached runtime artifacts
        if: steps.cache-runtime.outputs.cache-hit == 'true'
        run: |
          set -euo pipefail
          native_dir="$RUNTIME_ARTIFACTS_DIR/bin/native"
          wasm="$native_dir/net10.0-browser-$CONFIG-wasm/dotnet.native.wasm"
          if [[ ! -f "$wasm" ]]; then
            echo "::error::Cached runtime artifacts missing dotnet.native.wasm: $wasm"
            exit 1
          fi
          if [[ "${{ matrix.copy_pack }}" == "true" ]]; then
            lib_dir="$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/lib/net10.0"
            if [[ ! -d "$lib_dir" ]]; then
              echo "::error::Runtime lib directory not found: $lib_dir"
              exit 1
            fi
            if [[ ! -f "$lib_dir/System.Runtime.dll" ]]; then
              echo "::error::Runtime lib missing System.Runtime.dll: $lib_dir/System.Runtime.dll"
              exit 1
            fi
          fi

      - name: Build
        id: build-runtime
        if: steps.cache-runtime.outputs.cache-hit != 'true'
        env:
          EXTRA_CFLAGS: "-fPIC"
          EXTRA_CXXFLAGS: "-fPIC"
        run: |
          set -euo pipefail
          cache="$EM_CACHE_DIR"
          mkdir -p "$cache"
          export EM_CACHE="$cache"

          extra_cflags="-I$ICU_DIR/include -fPIC -DWASM_SUPPORTS_DLOPEN=1"
          extra_ld="-s MAIN_MODULE=${{ matrix.mm }}"
          wasm_enable_simd="true"
          cmake_args="-DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCLR_CMAKE_TARGET_OS=browser -DCLR_CMAKE_TARGET_ARCH=wasm -DCLR_CMAKE_TARGET_BROWSER=1"
          emcc_cflags="$extra_cflags"
          emcc_ldflags="$extra_ld"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            extra_cflags="${extra_cflags} -pthread"
            extra_ld="${extra_ld} -pthread -Wno-experimental"
            emcc_cflags="${emcc_cflags} -pthread -matomics -mbulk-memory"
            emcc_ldflags="${emcc_ldflags} -pthread -matomics -mbulk-memory"
          fi
          export EMCC_CFLAGS="$emcc_cflags"
          export EMCC_LDFLAGS="$emcc_ldflags"

          ./runtime/build.sh \
            -s mono.runtime+mono.wasmruntime+libs.native+packs \
            -os browser -arch wasm -c "$CONFIG" \
            /p:WasmEnableThreads=${{ matrix.threads }} \
            /p:BuildTests=false \
            /p:RunTests=false \
            "/p:ICULibDir=$ICU_LIB_DIR" \
            "/p:IcuDir=$ICU_DIR" \
            "/p:CMakeArgs=$cmake_args" \
            "/p:EmccExtraCFlags=$extra_cflags" \
            "/p:EmccExtraLDFlags=${extra_ld}" \
            "/p:WasmEnableSIMD=${wasm_enable_simd}" \
            "/p:WasmCachePath=$cache"

      - name: Validate wasm flags
        run: |
          set -euo pipefail
          native_src="$RUNTIME_ARTIFACTS_DIR/bin/native/net10.0-browser-$CONFIG-wasm/src"
          compile_rsp="$native_src/emcc-compile.rsp"
          link_rsp="$native_src/emcc-link.rsp"
          if [[ ! -f "$compile_rsp" ]]; then
            echo "::error::emcc-compile.rsp not found: $compile_rsp"
            exit 1
          fi
          if [[ ! -f "$link_rsp" ]]; then
            echo "::error::emcc-link.rsp not found: $link_rsp"
            exit 1
          fi
          if ! grep -q -- "-fPIC" "$compile_rsp"; then
            echo "::error::-fPIC not found in $compile_rsp"
            exit 1
          fi
          if ! grep -q -- "WASM_SUPPORTS_DLOPEN=1" "$compile_rsp"; then
            echo "::error::WASM_SUPPORTS_DLOPEN=1 not found in $compile_rsp"
            exit 1
          fi
          if ! grep -q -- "MAIN_MODULE=${{ matrix.mm }}" "$link_rsp"; then
            echo "::error::MAIN_MODULE=${{ matrix.mm }} not found in $link_rsp"
            exit 1
          fi

      - name: Collect diagnostics
        if: always()
        run: |
          set -euo pipefail
          out="$GITHUB_WORKSPACE/artifacts/diagnostics/${{ matrix.name }}"
          mkdir -p "$out"

          native_bin="$RUNTIME_ARTIFACTS_DIR/bin/native/net10.0-browser-Release-wasm"
          if [[ -d "$native_bin" ]]; then
            mkdir -p "$out/native-bin"
            if [[ -d "$native_bin/src" ]]; then
              cp -a "$native_bin/src" "$out/native-bin/"
            fi
            if [[ -f "$native_bin/CMakeCache.txt" ]]; then
              cp -f "$native_bin/CMakeCache.txt" "$out/native-bin/"
            fi
            for f in dotnet.native.wasm dotnet.native.js dotnet.native.js.map; do
              if [[ -f "$native_bin/$f" ]]; then
                cp -f "$native_bin/$f" "$out/native-bin/"
              fi
            done
          fi

          pack_base="$RUNTIME_ARTIFACTS_DIR/bin"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            pack_dir="$pack_base/microsoft.netcore.app.runtime.multithread.browser-wasm/$CONFIG/runtimes/browser-wasm/native"
          else
            pack_dir="$pack_base/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/native"
          fi
          if [[ -d "$pack_dir" ]]; then
            mkdir -p "$out/runtime-pack"
            if [[ -f "$pack_dir/dotnet.native.wasm" ]]; then
              cp -f "$pack_dir/dotnet.native.wasm" "$out/runtime-pack/"
            fi
          fi

          obj_root="$RUNTIME_ARTIFACTS_DIR/obj/native/net10.0-browser-Release-wasm"
          if [[ -d "$obj_root" ]]; then
            mkdir -p "$out/obj-native"
            find "$obj_root" -type f \( -name "flags.make" -o -name "link.txt" -o -name "CMakeCache.txt" \) | while read -r f; do
              rel="${f#$obj_root/}"
              mkdir -p "$out/obj-native/$(dirname "$rel")"
              cp -f "$f" "$out/obj-native/$rel"
            done
          fi

          if [[ -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/.emscripten" ]]; then
            cp -f "$GITHUB_WORKSPACE/runtime/src/mono/browser/emsdk/.emscripten" "$out/"
          fi
          if [[ -f "$EM_CACHE_DIR/sanity.txt" ]]; then
            cp -f "$EM_CACHE_DIR/sanity.txt" "$out/"
          fi
          if [[ -d "$RUNTIME_ARTIFACTS_DIR/log" ]]; then
            cp -a "$RUNTIME_ARTIFACTS_DIR/log" "$out/"
          fi
          if [[ -d /tmp/emscripten_temp ]]; then
            tar -czf "$out/emscripten_temp.tgz" -C /tmp emscripten_temp
          fi

      - name: Save runtime artifacts cache
        if: always() && steps.cache-runtime.outputs.cache-hit != 'true' && steps.build-runtime.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.RUNTIME_ARTIFACTS_DIR }}
          key: runtime-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ env.CONFIG }}-${{ env.RUNTIME_REF }}-${{ steps.versions.outputs.runtime_commit }}-${{ steps.versions.outputs.emsdk }}-${{ steps.versions.outputs.icu }}-threads-${{ matrix.threads }}-mm${{ matrix.mm }}-${{ matrix.name }}

      - name: Save emscripten build cache
        if: always() && steps.cache-emcache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.EM_CACHE_DIR }}
          key: emcache-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ steps.versions.outputs.emsdk }}-${{ matrix.name }}

      - name: Save NuGet cache
        if: always() && steps.cache-nuget.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-v${{ steps.version.outputs.value }}-${{ hashFiles('runtime/eng/Version.Details.xml') }}

      - name: Assemble artifacts
        run: |
          set -euo pipefail
          out="$GITHUB_WORKSPACE/artifacts/${{ matrix.name }}"
          native_dir="$RUNTIME_ARTIFACTS_DIR/bin/native/net10.0-browser-$CONFIG-wasm"
          if [[ ! -d "$native_dir" ]]; then
            echo "::error::Native output directory not found: $native_dir"
            exit 1
          fi
          mkdir -p "$out/native"
          cp -a "$native_dir/." "$out/native/"

          pkg_dir="$RUNTIME_ARTIFACTS_DIR/packages/$CONFIG/Shipping"
          if [[ "${{ matrix.threads }}" == "true" ]]; then
            pkg_pattern="Microsoft.NETCore.App.Runtime.Mono.multithread.browser-wasm.*.nupkg"
          else
            pkg_pattern="Microsoft.NETCore.App.Runtime.Mono.browser-wasm.*.nupkg"
          fi
          shopt -s nullglob
          pkgs=()
          for candidate in "$pkg_dir"/$pkg_pattern; do
            if [[ "$candidate" == *.symbols.nupkg ]]; then
              continue
            fi
            pkgs+=("$candidate")
          done
          shopt -u nullglob
          if [[ "${#pkgs[@]}" -ne 1 ]]; then
            echo "::error::Expected exactly one runtime pack (non-symbols, $pkg_pattern) under $pkg_dir, found ${#pkgs[@]}"
            exit 1
          fi
          pkg="${pkgs[0]}"
          if ! command -v unzip >/dev/null 2>&1; then
            echo "::error::unzip is required to extract System.Private.CoreLib.dll"
            exit 1
          fi
          unzip -j "$pkg" \
            "runtimes/browser-wasm/native/System.Private.CoreLib.dll" \
            -d "$out/native"
          unzip -j "$pkg" \
            "runtimes/browser-wasm/native/libmono-*.a" \
            -d "$out/native"
          if [[ ! -f "$out/native/System.Private.CoreLib.dll" ]]; then
            echo "::error::Missing System.Private.CoreLib.dll after extract: $out/native/System.Private.CoreLib.dll"
            exit 1
          fi
          if ! ls "$out/native"/libmono-*.a >/dev/null 2>&1; then
            echo "::error::Missing libmono-*.a after extract: $out/native"
            exit 1
          fi

          if [[ "${{ matrix.copy_pack }}" == "true" ]]; then
            lib_dir="$RUNTIME_ARTIFACTS_DIR/bin/microsoft.netcore.app.runtime.browser-wasm/$CONFIG/runtimes/browser-wasm/lib/net10.0"
            if [[ ! -d "$lib_dir" ]]; then
              echo "::error::Runtime lib directory not found: $lib_dir"
              exit 1
            fi
            out_lib="$out/lib/net10.0"
            mkdir -p "$out_lib"
            cp -a "$lib_dir/." "$out_lib/"

            pkg_dir="$RUNTIME_ARTIFACTS_DIR/packages/$CONFIG/Shipping"
            pkg_pattern="Microsoft.NETCore.App.Runtime.Mono.browser-wasm.*.nupkg"
            shopt -s nullglob
            pkgs=()
            for candidate in "$pkg_dir"/$pkg_pattern; do
              if [[ "$candidate" == *.symbols.nupkg ]]; then
                continue
              fi
              pkgs+=("$candidate")
            done
            shopt -u nullglob
            if [[ "${#pkgs[@]}" -ne 1 ]]; then
              echo "::error::Expected exactly one runtime pack (non-symbols, $pkg_pattern) under $pkg_dir, found ${#pkgs[@]}"
              exit 1
            fi
            pkg="${pkgs[0]}"
            unzip -j "$pkg" \
              "runtimes/browser-wasm/lib/net10.0/Microsoft.NETCore.App.deps.json" \
              "runtimes/browser-wasm/lib/net10.0/Microsoft.NETCore.App.runtimeconfig.json" \
              -d "$out_lib"
            if [[ ! -f "$out_lib/Microsoft.NETCore.App.deps.json" ]]; then
              echo "::error::Missing Microsoft.NETCore.App.deps.json after extract: $out_lib"
              exit 1
            fi
            if [[ ! -f "$out_lib/Microsoft.NETCore.App.runtimeconfig.json" ]]; then
              echo "::error::Missing Microsoft.NETCore.App.runtimeconfig.json after extract: $out_lib"
              exit 1
            fi
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runtime-wasm-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}
          if-no-files-found: error
          retention-days: 1

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/input

      - name: Validate downloaded artifacts
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/artifacts/input"
          variants=(
            "runtime-wasm-st-mm1"
            "runtime-wasm-st-mm2"
            "runtime-wasm-mt-mm1"
            "runtime-wasm-mt-mm2"
          )
          for v in "${variants[@]}"; do
            native_dir="$root/$v/native"
            if [[ ! -d "$native_dir" ]]; then
              echo "::error::Missing native artifact directory: $native_dir"
              exit 1
            fi
            if [[ ! -f "$native_dir/dotnet.native.wasm" ]]; then
              echo "::error::Missing dotnet.native.wasm in $native_dir"
              exit 1
            fi
            if [[ ! -f "$native_dir/System.Private.CoreLib.dll" ]]; then
              echo "::error::Missing System.Private.CoreLib.dll in $native_dir"
              exit 1
            fi
          done
          lib_dir="$root/runtime-wasm-st-mm1/lib/net10.0"
          if [[ ! -d "$lib_dir" ]]; then
            echo "::error::Missing lib directory: $lib_dir"
            exit 1
          fi
          if [[ ! -f "$lib_dir/System.Runtime.dll" ]]; then
            echo "::error::Missing System.Runtime.dll in $lib_dir"
            exit 1
          fi

      - name: Pack merged NuGet
        run: |
          set -euo pipefail
          out="$GITHUB_WORKSPACE/artifacts/nuget"
          mkdir -p "$out"
          dotnet pack src/RuntimeWasm.NuGet/RuntimeWasm.NuGet.csproj -c Release -p:ArtifactsRoot="$GITHUB_WORKSPACE/artifacts/input" -o "$out"

      - name: Upload merged NuGet
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-wasm-packages
          path: artifacts/nuget
          if-no-files-found: error
          retention-days: 1
